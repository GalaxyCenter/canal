
## 简介

这是在原版canal上的重构。

1、修改全量写入mysql 的逻辑，原有逻辑在数据量超过1w后启用多线程分页读取，实测1000w数据对源端数据库压力过大（4核数据库）4，16，32线程测试，cpu使用率都在200%-400%；只读不写的测试， 20w分一页，55个线程分页读取， 1个线程池数据耗时563838 毫秒，55个线程分页读取，4个线程池，耗时228851 毫秒；直接读全表79068 毫秒；直接全表纯读反而速度最快，而且mysql的cpu利用不超50%； 符合生产使用场景。即低cpu迁移数据，对生产影响降到低；

2、修改插入逻辑 原有逻辑是一条一条写入目标，性能差速度慢；现在改成批量插入，如果遇到错误再一条一条插入，显著提升全量写入速度。



1读-32 线程写入: 3864810 毫秒

1读 16线程写入: 4370879 毫秒

16线程读写： 4835523 毫秒

经过测试使用新逻辑写入性能更好，mysql 的cpu 利用最低



3、重构实时同步逻辑，当update失败（目标不存在的场景）则insert到目标。

4、重构全量同步，添加写入模式设置，当设置为覆盖的时候，写入目标遇到主键冲突则删除后重新插入，默认使用跳过逻辑。 功能3，4主要解决实时全量同步数据遇到不一致的问题， 比如一条记录被更新了，实时同步到目标的时候因为目标是空表会导致更新失败。然后执行全量同步的时候有可能读到的是更新前的内容，导致插入到目标的时候是旧的数据。
